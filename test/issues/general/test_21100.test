# name: test/issues/general/test_21100.test
# description: Issue 21100 - duckdb 1.5: Issue with struct and write ahead log
# group: [general]

load __TEST_DIR__/test_struct_null.db

statement ok
set threads=1;

statement ok
SET wal_autocheckpoint='1MiB'

statement ok
CREATE TABLE tl(
    data INT[]
)

statement ok
INSERT INTO tl VALUES (NULL)

statement ok
UPDATE tl SET data = [42]

query I
SELECT stats(data) from tl
----
[[Min: 42, Max: 42][Has Null: false, Has No Null: true]][Has Null: true, Has No Null: true]

# Bug, actually returns 0
query I
SELECT COUNT(*) FROM tl WHERE data IS NOT NULL
----
1

statement ok
CREATE TABLE t(
    data STRUCT(a INTEGER)
)

statement ok
INSERT INTO t VALUES (NULL)

statement ok
UPDATE t SET data = {'a': 42}


query I
SELECT stats(data) from t
----
 {a: [Min: 42, Max: 42][Has Null: true, Has No Null: true]}[Has Null: true, Has No Null: true]

# Bug, actually returns 0
query I
SELECT COUNT(*) FROM t WHERE data IS NOT NULL
----
1